// Copyright (c) T.Yoshimura 2023
// https://github.com/tk-yoshimura

using System.Diagnostics;
using System.Runtime.CompilerServices;

namespace EulerQFP64 {
    public static class EulerQ {
        public static double Value(double q) {
            return double.Exp(LogValue(q));
        }

        public static double LogValue(double q) {
            if (!(q >= -1.0 && q <= 1.0)) {
                return double.NaN;
            }
            if (double.Abs(q) == 1.0) {
                return double.NegativeInfinity;
            }

            double v = q switch {
                < -0.984375 => Mn1(q),
                < -0.9375 => Mn0984375(q),
                < -0.875 => Mn09375(q),
                < -0.75 => Mn0875(q),
                < -0.5 => Mn075(q),
                < 0.0 => Mn05(q),
                < 0.5 => Mp05(q),
                < 0.75 => Mp075(q),
                < 0.875 => Mp0875(q),
                < 0.9375 => Mp09375(q),
                < 0.984375 => Mp0984375(q),
                _ => Mp1(q),
            };

            double y = q * (v * q - 1.0) / (1.0 - q * q);

            return y;
        }

        private static double Mp05(double q) {
            Debug.Assert(q >= 0.0 && q <= 0.5, nameof(q));

            double u = 0.5 - q;

            double y = Fma(
                -1.72618628443724483958e0, u, Fma(
                5.24404714564638082403e-1, u, Fma(
                3.61622794236175166830e0, u, Fma(
                -7.51182329646319018583e0, u, Fma(
                1.05300819524577435229e0, u, Fma(
                6.77424971893010443206e0, u, Fma(
                -6.99771932850581144404e0, u, Fma(
                1.25820797151313488459e0, u, Fma(
                8.28828790535397556703e-1, u,
                -4.23546108541692999956e-1)))))))))
                / Fma(
                1.00000000000000000000e0, u, Fma(
                3.87009800714722462532e-2, u, Fma(
                -2.29838968116239186209e0, u, Fma(
                3.75474275136503763507e0, u, Fma(
                9.20823022563193096920e-1, u, Fma(
                -4.57188738434352002892e0, u, Fma(
                3.16801417024830623655e0, u, Fma(
                4.90099930615513540575e-1, u, Fma(
                -9.15069238425613036001e-1, u,
                2.38938071923963921250e-1)))))))));

            return y;
        }

        private static double Mp075(double q) {
            Debug.Assert(q >= 0.5 && q <= 0.75, nameof(q));

            double u = 0.75 - q;

            double y = Fma(
                -1.90534401733318591855e0, u, Fma(
                -1.30214959257194369038e1, u, Fma(
                -2.16575775151825625121e1, u, Fma(
                1.15438482897867733811e1, u, Fma(
                3.27141484108157193315e1, u, Fma(
                -8.34939181661238358052e0, u, Fma(
                -1.15060598181280728273e1, u,
                1.01540569143971616264e0)))))))
                / Fma(
                1.00000000000000000000e0, u, Fma(
                7.30127040333201965085e0, u, Fma(
                1.42602280246681611713e1, u, Fma(
                -2.22602402035543163216e0, u, Fma(
                -2.08332488943957559509e1, u, Fma(
                -9.42785154500607453462e-1, u, Fma(
                8.46690365658294634512e0, u,
                7.59089621641732896605e-1)))))));

            return y;
        }

        private static double Mp0875(double q) {
            Debug.Assert(q >= 0.75 && q <= 0.875, nameof(q));

            double u = 0.875 - q;

            double y = Fma(
                -2.03698828479556542876e0, u, Fma(
                -3.10095250473830549166e1, u, Fma(
                -1.48257088706339227696e2, u, Fma(
                -2.03429276544207083699e2, u, Fma(
                1.30776820022382479869e2, u, Fma(
                2.40512168601910783299e2, u,
                -4.64544037028304267752e0))))))
                / Fma(
                1.00000000000000000000e0, u, Fma(
                1.58490590351932980476e1, u, Fma(
                8.14897646055311258261e1, u, Fma(
                1.35799049525835315536e2, u, Fma(
                -3.04330638849023126255e1, u, Fma(
                -1.60211829836048197801e2, u,
                -3.20171220637790966373e1))))));

            return y;
        }

        private static double Mp09375(double q) {
            Debug.Assert(q >= 0.875 && q <= 0.9375, nameof(q));

            double u = 0.9375 - q;

            double y = Fma(
                -2.12919328417527086244e0, u, Fma(
                -9.03286450961302479295e1, u, Fma(
                -1.40677381940520826252e3, u, Fma(
                -9.80290351831204974506e3, u, Fma(
                -2.94724442054619324746e4, u, Fma(
                -2.92339474093592291109e4, u,
                -1.53544316321426632420e3))))))
                / Fma(
                1.00000000000000000000e0, u, Fma(
                4.32420367679400502760e1, u, Fma(
                6.93351813528432213181e2, u, Fma(
                5.07056241637019772625e3, u, Fma(
                1.67030950958328548301e4, u, Fma(
                2.07200054810502143109e4, u,
                5.36393103634383030213e3))))));

            return y;
        }

        private static double Mp0984375(double q) {
            Debug.Assert(q >= 0.9375 && q <= 0.984375, nameof(q));

            double u = 0.984375 - q;

            double y = Fma(
                -2.23051609258273810185e0, u, Fma(
                -3.99065718422487621676e2, u, Fma(
                -2.76089166539588495653e4, u, Fma(
                -9.36633837374113058741e5, u, Fma(
                -1.63527682203332382054e7, u, Fma(
                -1.41465234513312619495e8, u, Fma(
                -5.33601092796171805594e8, u, Fma(
                -6.36504523729623137273e8, u,
                -3.85232647399780148939e7))))))))
                / Fma(
                1.00000000000000000000e0, u, Fma(
                1.80197730578713934519e2, u, Fma(
                1.25968849442008154795e4, u, Fma(
                4.34131192639576261313e5, u, Fma(
                7.77368589756014100000e6, u, Fma(
                7.02740095062278558901e7, u, Fma(
                2.89070623864781983509e8, u, Fma(
                4.28880360836510714208e8, u,
                1.21591285734126134608e8))))))));

            return y;
        }

        private static double Mp1(double q) {
            Debug.Assert(q >= 0.984375 && q <= 1.0, nameof(q));

            double u = 1.0 - q;

            double y = Fma(
                -2.28986813369645286673e0, u, Fma(
                -1.58286282506176753883e6, u, Fma(
                -2.15500980067436709567e11, u, Fma(
                -1.03530657607034795756e16, u, Fma(
                -2.23548403038784344497e20, u, Fma(
                -2.48112156226228384402e24, u, Fma(
                -1.54190906651454623414e28, u, Fma(
                -5.69139963189122276767e31, u, Fma(
                -1.30194729434766904755e35, u, Fma(
                -1.90450246208203648782e38, u, Fma(
                -1.82309305660828563855e41, u, Fma(
                -1.16114475945685470585e44, u, Fma(
                -4.97572906054597218000e46, u, Fma(
                -1.44354197071407051046e49, u, Fma(
                -2.83956821571739834003e51, u, Fma(
                -3.77423698475115269045e53, u, Fma(
                -3.35939410631568000735e55, u, Fma(
                -1.97127125558051024720e57, u, Fma(
                -7.44224633313939527596e58, u, Fma(
                -1.74270991390395977327e60, u, Fma(
                -2.39438812823319343670e61, u, Fma(
                -1.76747917549850013192e62, u, Fma(
                -6.00770364748270523810e62, u, Fma(
                -6.71789973683795975240e62, u,
                -3.77582085154553275528e61))))))))))))))))))))))))
                / Fma(
                1.00000000000000000000e0, u, Fma(
                6.91252510443877439150e5, u, Fma(
                9.41142816645731877083e10, u, Fma(
                4.52169339594285139107e15, u, Fma(
                9.76445608345263232987e19, u, Fma(
                1.08391299804742114661e24, u, Fma(
                6.73766818282651604075e27, u, Fma(
                2.48782918480023054712e31, u, Fma(
                5.69385705711137408472e34, u, Fma(
                8.33464057312760969931e37, u, Fma(
                7.98569160171673138025e40, u, Fma(
                5.09247674082946531239e43, u, Fma(
                2.18587887168394252511e46, u, Fma(
                6.35592505008797962067e48, u, Fma(
                1.25408972762399160102e51, u, Fma(
                1.67385114336622097427e53, u, Fma(
                1.49848624977739052890e55, u, Fma(
                8.86469336378986720896e56, u, Fma(
                3.38619946588229196941e58, u, Fma(
                8.06956775478321354180e59, u, Fma(
                1.13973282355433455632e61, u, Fma(
                8.81643465854299819395e61, u, Fma(
                3.27874157173084519317e62, u, Fma(
                4.57815090695361233958e62, u,
                1.25748081025845137587e62))))))))))))))))))))))));

            return y;
        }

        private static double Mn05(double q) {
            Debug.Assert(q <= 0 && q >= -0.5, nameof(q));

            double u = 0.5 + q;

            double y = Fma(
                -1.42634409379923123138e0, u, Fma(
                -2.50763436959253106768e-1, u, Fma(
                -3.70613556905154918153e0, u, Fma(
                1.00212471233851485346e0, u, Fma(
                -6.58212213290247216320e-1, u, Fma(
                5.44562447009024268552e-1, u, Fma(
                7.97319630231260713270e0, u, Fma(
                -5.35593580795482781376e0, u, Fma(
                9.49572197407253267176e0, u,
                -3.12033394645332461736e0)))))))))
                / Fma(
                1.00000000000000000000e0, u, Fma(
                2.57882590249334081844e-1, u, Fma(
                2.13142916369696050370e0, u, Fma(
                -4.14737020292078079370e-1, u, Fma(
                -6.50898732740366085378e-1, u, Fma(
                7.89748691284484114087e-1, u, Fma(
                -6.28226878459132804702e0, u, Fma(
                3.96148510682594582594e0, u, Fma(
                -5.72761578860671171389e0, u,
                2.32907613575191486278e0)))))))));

            return y;
        }

        private static double Mn075(double q) {
            Debug.Assert(q <= -0.5 && q >= -0.75, nameof(q));

            double u = 0.75 + q;

            double y = Fma(
                -1.50613285483940098893e0, u, Fma(
                -6.35984731310646389041e0, u, Fma(
                -8.33935106299447180693e0, u, Fma(
                -3.28665728188872923941e1, u, Fma(
                -5.59304879647109373830e1, u, Fma(
                -1.04253666522683469023e1, u, Fma(
                -9.71400182421185170622e1, u, Fma(
                -3.90388467440923834336e1, u,
                -1.20257979017962702982e1))))))))
                / Fma(
                1.00000000000000000000e0, u, Fma(
                4.59626699919116988904e0, u, Fma(
                6.43469653126720870690e0, u, Fma(
                2.15654291070759053932e1, u, Fma(
                4.22732733985180116812e1, u, Fma(
                6.65936257029587459935e0, u, Fma(
                5.17858727633115648592e1, u, Fma(
                4.15749365589585277345e1, u,
                -1.07955198909684050820e1))))))));

            return y;
        }

        private static double Mn0875(double q) {
            Debug.Assert(q <= -0.75 && q >= -0.875, nameof(q));

            double u = 0.875 + q;

            double y = Fma(
                -1.60052201918622949335e0, u, Fma(
                -2.23255613558494160184e1, u, Fma(
                -9.04059335325002437773e1, u, Fma(
                -7.33797494885066477360e1, u, Fma(
                9.29117187662118936536e1, u, Fma(
                -6.24452167947138107366e1, u,
                -6.58858473958651173538e1))))))
                / Fma(
                1.00000000000000000000e0, u, Fma(
                1.45761725288917580529e1, u, Fma(
                6.39601232875477015455e1, u, Fma(
                6.68416579978625359464e1, u, Fma(
                -7.01509883891672255197e1, u, Fma(
                -4.67638931242128937790e0, u,
                7.89516424643140890866e1))))));

            return y;
        }

        private static double Mn09375(double q) {
            Debug.Assert(q <= -0.875 && q >= -0.9375, nameof(q));

            double u = 0.9375 + q;

            double y = Fma(
                -1.67655479885997588893e0, u, Fma(
                -5.39690368945295830108e1, u, Fma(
                -5.82092304245265657887e2, u, Fma(
                -2.36060014845177974952e3, u, Fma(
                -2.58235191398999463174e3, u, Fma(
                5.65514345241751072368e2, u,
                -8.19187482925757494550e2))))))
                / Fma(
                1.00000000000000000000e0, u, Fma(
                3.30821213522277669634e1, u, Fma(
                3.73114219011418974448e2, u, Fma(
                1.64441094720093020031e3, u, Fma(
                2.21564760037353508261e3, u, Fma(
                -3.49165751530033729926e2, u,
                -2.54819523618294234309e2))))));

            return y;
        }

        private static double Mn0984375(double q) {
            Debug.Assert(q <= -0.9375 && q >= -0.984375, nameof(q));

            double u = 0.984375 + q;

            double y = Fma(
                -1.76668197304391687812e0, u, Fma(
                -3.00239142456692348961e2, u, Fma(
                -1.93697799858742092130e4, u, Fma(
                -5.94817778802791001408e5, u, Fma(
                -8.91918728175877957293e6, u, Fma(
                -5.94511068070830365418e7, u, Fma(
                -1.26115319227610061404e8, u, Fma(
                3.88974851681411089146e7, u,
                4.43071437714679445586e7))))))))
                / Fma(
                1.00000000000000000000e0, u, Fma(
                1.71438048961106120919e2, u, Fma(
                1.12037996379360402695e4, u, Fma(
                3.51029258874727518733e5, u, Fma(
                5.44412878076322996588e6, u, Fma(
                3.86905351399564735445e7, u, Fma(
                9.65714768506526393936e7, u, Fma(
                -9.49471672650833171594e5, u,
                -7.73743369267007334538e7))))))));

            return y;
        }

        private static double Mn1(double q) {
            Debug.Assert(q <= -0.984375 && q >= -1.0, nameof(q));

            double u = 1.0 + q;

            double y = Fma(
                -1.82246703342411321105e0, u, Fma(
                -1.25211884620109379123e6, u, Fma(
                -1.69258946624755413556e11, u, Fma(
                -8.06517815945558353138e15, u, Fma(
                -1.72539125726571739060e20, u, Fma(
                -1.89512295238295413260e24, u, Fma(
                -1.16407961798552473506e28, u, Fma(
                -4.24110990712178671377e31, u, Fma(
                -9.56115988221122941284e34, u, Fma(
                -1.37583303708301553435e38, u, Fma(
                -1.29277811452036704307e41, u, Fma(
                -8.06123337393978693837e43, u, Fma(
                -3.37115711583245148579e46, u, Fma(
                -9.50624182504477683647e48, u, Fma(
                -1.80817823228886294642e51, u, Fma(
                -2.30816268991684650448e53, u, Fma(
                -1.95490185422295537056e55, u, Fma(
                -1.07736958854216479348e57, u, Fma(
                -3.74690266868591566809e58, u, Fma(
                -7.83834117947555438413e59, u, Fma(
                -9.11818248132877356589e60, u, Fma(
                -5.10038179592332184619e61, u, Fma(
                -9.46939916972751098418e61, u, Fma(
                3.35892727913942291388e61, u,
                3.19761364026839513557e61))))))))))))))))))))))))
                / Fma(
                1.00000000000000000000e0, u, Fma(
                6.87053791843874616798e5, u, Fma(
                9.28779768398974486204e10, u, Fma(
                4.42595605108940851314e15, u, Fma(
                9.46968599757972174296e19, u, Fma(
                1.04033149915293102268e24, u, Fma(
                6.39213633350069524658e27, u, Fma(
                2.32985389674433246713e31, u, Fma(
                5.25558088421639742875e34, u, Fma(
                7.56895554971333296662e37, u, Fma(
                7.12008285055745995632e40, u, Fma(
                4.44658652650995309394e43, u, Fma(
                1.86337492215832886109e46, u, Fma(
                5.26914150976069898536e48, u, Fma(
                1.00603634716718081800e51, u, Fma(
                1.29088313240869892996e53, u, Fma(
                1.10120857938369475868e55, u, Fma(
                6.13117840746463583843e56, u, Fma(
                2.16441569837780168796e58, u, Fma(
                4.63253147554529879477e59, u, Fma(
                5.59456326857849628603e60, u, Fma(
                3.35388631825438367775e61, u, Fma(
                7.40177698670252613477e61, u, Fma(
                -4.76893768415698776256e60, u,
                -5.76797277509686017458e61))))))))))))))))))))))));

            return y;
        }

        [MethodImpl(MethodImplOptions.AggressiveInlining)]
        private static double Fma(double z, double x, double y) {
            return Math.FusedMultiplyAdd(x, y, z);
        }
    }
}